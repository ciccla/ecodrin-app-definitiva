<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Cliente - Ecodrin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <div class="logo-utente">
    <img src="img/ecodrin.png" alt="Logo Ecodrin" />
    <span>üë§ Cliente</span>
  </div>
  <div class="nav-buttons">
    <button onclick="location.href='dashboard.html'">üè† Dashboard</button>
    <button onclick="location.href='prenotazione.html'">‚ûï Prenotazione</button>
    <button onclick="location.href='trasporto.html'">üöö Trasporto</button>
    <button onclick="location.href='/cliente/logout'">üîí Logout</button>
  </div>
</header>

<h1 style="text-align:center; margin: 20px 0;">Le tue Prenotazioni</h1>

<div id="prenotazioni" style="padding: 0 20px;"></div>

<h1 style="text-align:center; margin: 40px 0 20px;">Le tue Richieste di Trasporto</h1>

<div id="trasporti" style="padding: 0 20px;"></div>

<div id="notify"></div>

<audio id="notification-sound" src="https://notificationsounds.com/storage/sounds/file-sounds-1153-pristine.mp3" preload="auto"></audio>

<script>
  const notifyBox = document.getElementById('notify');
  const notificationSound = document.getElementById('notification-sound');
  let messaggiLetti = {};

  function notify(msg, success = true) {
    notifyBox.innerText = msg;
    notifyBox.style.background = success ? '#2e7d32' : '#c62828';
    notifyBox.style.display = 'block';
    setTimeout(() => notifyBox.style.display = 'none', 4000);
  }

  function playNotificationSound() {
    if (notificationSound) notificationSound.play();
  }
</script>
<script>
  // -------------------- Prenotazioni --------------------
  fetch('/cliente/prenotazioni')
    .then(res => res.json())
    .then(data => {
      const div = document.getElementById('prenotazioni');
      if (!data.length) {
        div.innerHTML = '<p style="text-align:center;">Nessuna prenotazione trovata.</p>';
        return;
      }
  
      let html = `<table><thead><tr>
        <th>ID</th><th>Produttore</th><th>Codice CER</th><th>Quantit√†</th><th>Data</th><th>Certificato</th><th>Stato</th><th>Chat</th>
      </tr></thead><tbody>`;
  
      data.forEach(p => {
        const statoClass = (p.stato || 'in attesa').replace(/\s/g, '-');
        html += `<tr>
          <td>${p.id}</td>
          <td>${p.produttore}</td>
          <td>${p.codice_cer}</td>
          <td>${p.quantita}</td>
          <td>${p.giorno_conferimento}</td>
          <td>${p.certificato_analitico ? `<a href="/impianto/download-certificato/${p.certificato_analitico}" target="_blank">Scarica</a>` : '-'}</td>
          <td><span class="badge ${statoClass}">${p.stato || 'in attesa'}</span></td>
          <td>
            <div class="chat-box">
              <div class="chat-messages" id="chat-messages-${p.id}"></div>
              <input type="text" class="chat-input" id="msg-input-${p.id}" placeholder="Scrivi..." onkeydown="if(event.key==='Enter') inviaMessaggioPrenotazione(${p.id})">
              <button onclick="inviaMessaggioPrenotazione(${p.id})">Invia</button>
            </div>
          </td>
        </tr>`;
        setTimeout(() => caricaChat('prenotazione', p.id), 0);
      });
  
      html += '</tbody></table>';
      div.innerHTML = html;
    });
  
  function caricaChat(tipo, id) {
    fetch(`/chat/${tipo}/${id}`)
      .then(res => res.json())
      .then(msgs => {
        const container = document.getElementById(`chat-messages-${id}`);
        if (!container) return;
  
        container.innerHTML = '';
        msgs.forEach(m => {
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (m.mittente === 'admin' ? 'bubble-left' : 'bubble-right');
          bubble.innerText = m.messaggio;
          container.appendChild(bubble);
        });
        container.scrollTop = container.scrollHeight;
      });
  }
  
  function inviaMessaggioPrenotazione(id) {
    const input = document.getElementById(`msg-input-${id}`);
    const testo = input.value.trim();
    if (!testo) return;
    fetch('/chat/prenotazione', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prenotazione_id: id, mittente: 'cliente', messaggio: testo })
    }).then(() => {
      input.value = '';
      caricaChat('prenotazione', id);
    });
  }
  
  // -------------------- Trasporti --------------------
  fetch('/cliente/richieste-trasporto')
    .then(res => res.json())
    .then(data => {
      const div = document.getElementById('trasporti');
      if (!data.length) {
        div.innerHTML = '<p style="text-align:center;">Nessuna richiesta di trasporto trovata.</p>';
        return;
      }
  
      let html = `<table><thead><tr>
        <th>ID</th><th>Produttore</th><th>Codice CER</th><th>Automezzo</th>
        <th>Data</th><th>Orario</th><th>Referente</th><th>Prezzo</th><th>Stato</th><th>Chat</th>
      </tr></thead><tbody>`;
  
      data.forEach(t => {
        const statoClass = (t.stato || 'in attesa').replace(/\s/g, '-');
        html += `<tr>
          <td>${t.id}</td>
          <td>${t.produttore}</td>
          <td>${t.codice_cer}</td>
          <td>${t.tipo_automezzo}</td>
          <td>${t.data_trasporto}</td>
          <td>${t.orario_preferito}</td>
          <td>${t.numero_referente}</td>
          <td>${parseFloat(t.prezzo_pattuito).toFixed(2)} ‚Ç¨</td>
          <td><span class="badge ${statoClass}">${t.stato}</span></td>
          <td>
            <div class="chat-box">
              <div class="chat-messages" id="chat-messages-trasporto-${t.id}"></div>
              <input type="text" class="chat-input" id="msg-input-trasporto-${t.id}" placeholder="Scrivi..." onkeydown="if(event.key==='Enter') inviaMessaggioTrasporto(${t.id})">
              <button onclick="inviaMessaggioTrasporto(${t.id})">Invia</button>
            </div>
          </td>
        </tr>`;
        setTimeout(() => caricaChatTrasporto(t.id), 0);
      });
  
      html += '</tbody></table>';
      div.innerHTML = html;
    });
  
  function caricaChatTrasporto(id) {
    fetch(`/chat/trasporto/${id}`)
      .then(res => res.json())
      .then(msgs => {
        const container = document.getElementById(`chat-messages-trasporto-${id}`);
        if (!container) return;
  
        container.innerHTML = '';
        msgs.forEach(m => {
          const bubble = document.createElement('div');
          bubble.className = 'chat-bubble ' + (m.mittente === 'admin' ? 'bubble-left' : 'bubble-right');
          bubble.innerText = m.messaggio;
          container.appendChild(bubble);
        });
        container.scrollTop = container.scrollHeight;
      });
  }
  
  function inviaMessaggioTrasporto(id) {
    const input = document.getElementById(`msg-input-trasporto-${id}`);
    const testo = input.value.trim();
    if (!testo) return;
    fetch('/chat/trasporto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trasporto_id: id, mittente: 'cliente', messaggio: testo })
    }).then(() => {
      input.value = '';
      caricaChatTrasporto(id);
    });
  }
  
  setInterval(() => {
    document.querySelectorAll('[id^="chat-messages-"]').forEach(box => {
      const id = box.id.replace('chat-messages-', '');
      if (!isNaN(id)) caricaChat('prenotazione', parseInt(id));
    });
    document.querySelectorAll('[id^="chat-messages-trasporto-"]').forEach(box => {
      const id = box.id.replace('chat-messages-trasporto-', '');
      if (!isNaN(id)) caricaChatTrasporto(parseInt(id));
    });
  }, 2000); // Refresh chat ogni 2 secondi
  
  </script>
  
  </body>
  </html>
  